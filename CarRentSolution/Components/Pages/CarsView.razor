@page "/cars"
@using Microsoft.AspNetCore.Components.Authorization

@rendermode InteractiveServer

<PageTitle>Автопарк</PageTitle>

<div class="page-container">
    <h3>Автопарк</h3>
    @if (isLoaded)
    {
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" placeholder="Поиск" @bind="search"/>
                    <div class="input-group-append">
                        <button class="btn btn-primary" @onclick="async () => await LoadCars()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <select class="form-control" @bind="brandId">
                        <option value="0" selected>Все марки</option>
                        @foreach (var item in _brands)
                        {
                            <option value="@item.Id">@item.Name</option>
                        }
                    </select>
                    <div class="input-group-append">
                        <button class="btn btn-primary" @onclick="async () => await LoadCars()">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
            </div>
            <AuthorizeView>
                <Authorized>
                    <div class="col-md-6">
                        <a class="btn btn-primary" style="margin-top: 5px" href="auto">Добавить</a>
                    </div>
                </Authorized>
            </AuthorizeView>
        </div>

        <div class="cars-container">
            @if (_autos.Count == 0)
            {
                <h5>Нет результатов</h5>
            }
            else
            {
                @foreach (Auto auto in _autos)
                {
                    <div
                        class="card"
                        @onclick="() => SelectAuto(auto)">
                        @if (auto.Photo != null)
                        {
                            <img
                                class="card-img-top"
                                src="data:image/jpg;base64,@auto.Photo"
                                alt="@auto.Model.Brand.Name @auto.Model.Name">
                        }
                        else
                        {
                            <img
                                class="card-img-top"
                                src="empty.png"
                                alt="@auto.Model.Brand.Name @auto.Model.Name">
                        }
                        <div class="card-body">
                            <div style="border-right: white solid 1px">
                                <h5 class="card-title">@auto.Model.Brand.Name @auto.Model.Name</h5>
                            </div>
                            <p
                                class="card-text"
                                style="margin-left: 15%">@auto.RentPrice рублей</p>
                        </div>
                    </div>
                }
            }
        </div>
    }

    <p style="color: #7f7f7f; text-align: center; margin: 5px">Найдено @_autos.Count из @_totalCount автомобилей</p>

    @if (_selectedAuto != null)
    {
        <div class="modal" style="display: block;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@_selectedAuto.Model.Brand.Name @_selectedAuto.Model.Name (@_selectedAuto.Year)</h5>
                    <button type="button" class="close" @onclick="() => _selectedAuto = null">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div
                    class="modal-body"
                    style="display: grid; grid-template-columns: 1fr auto">
                    <div>
                        @if (_selectedAuto.Photo != null)
                        {
                            <img
                                class="modal-img"
                                src="data:image/jpg;base64,@_selectedAuto.Photo"/>
                        }
                        else
                        {
                            <img
                                class="card-img-top"
                                src="empty.png">
                        }
                        <p>Цена: @_selectedAuto.RentPrice рублей (сутки)</p>
                        <p>Цвет: @_selectedAuto.Color</p>
                    </div>
                    <AuthorizeView>
                        <NotAuthorized>
                            <form
                                style="padding: 15px; display: flex; flex-direction: column; gap: 10px; width: 20vw"
                                name="order-form"
                                @onsubmit="CreateOrder">
                                <label
                                    for="mname"
                                    class="place">Ваше ФИО:</label>
                                <input
                                    name="mname"
                                    required
                                    @bind="Order.ClientFullName"
                                    placeholder="Ваше фио"
                                    class="form-control"/>
                                <label
                                    for="phone"
                                    class="place">Ваш телефон:</label>
                                <input
                                    id="phone"
                                    name="phone"
                                    type="text"
                                    maxlength="17"
                                    required
                                    @bind="Order.ClientPhone"
                                    placeholder="Ваш номер"
                                    class="form-control"/>
                                <label
                                    for="start"
                                    class="place">Аренда с:</label>
                                <input
                                    name="start"
                                    required
                                    @bind="Order.DateStartRent"
                                    type="date"
                                    class="form-control"
                                    placeholder="Аренда с"/>
                                <label
                                    for="end"
                                    class="place">Аренда до:</label>
                                <input
                                    name="end"
                                    required
                                    @bind="Order.DateEndRent"
                                    type="date"
                                    class="form-control"
                                    placeholder="Аренда по"/>

                                @if (_formMessageModel != null)
                                {
                                    <label
                                        style="color: @_formMessageModel.Color">@_formMessageModel.Message</label>
                                }
                                @if (_canCreateOrder)
                                {
                                    <button
                                        type="submit"
                                        class="btn btn-primary">Забронировать
                                    </button>
                                }
                            </form>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
                <AuthorizeView>
                    <Authorized>
                        <a class="btn btn-primary"
                           href="auto/@_selectedAuto.Vin/true">Информация
                        </a>
                    </Authorized>
                </AuthorizeView>
                <div class="modal-footer">
                    <div>
                        <button
                            class="btn btn-secondary"
                            @onclick="ShowPrevious"
                            disabled="@IsFirstAuto">Назад
                        </button>
                        <button
                            class="btn btn-secondary"
                            @onclick="ShowNext"
                            disabled="@IsLastAuto">Вперед
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>